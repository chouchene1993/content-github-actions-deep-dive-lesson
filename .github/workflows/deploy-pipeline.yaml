name: Deploy Azure Function
on: [push]

jobs:

  lint:
    runs-on: ubuntu-latest
    steps: 
      - name: Check out code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install libraries
        run: pip install flake8
      - name: Lint with flake8
        run: |
            cd function
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install libraries
        run: |
            cd function
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then pip install -r requirements.txt -t .; fi 
      - name: Zip bundle
        run: |
            cd function
            zip -r ../${{ github.sha }}.zip .
      - name: Archive artifact
        uses: actions/upload-artifact@v2
        with:
          name: zipped-bundle
          path: ${{ github.sha }}.zip
        
  publish:
   runs-on: ubuntu-latest
   needs: build
   steps:
    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.github_token }} # This token is provided by Actions, you do not need to create your own token
      with:
        tag_name: ${{ github.run_number }}
        release_name: Release ${{ github.run_number }}
        body: New release for ${{ github.sha }}. Release notes can be found in the docs.
        draft: false
        prerelease: false

        ### new step to download an artifact ###
      
    - name: Download artifact
      uses: actions/download-artifact@v2
      with:
       name: zipped-bundle

      ##new step to upload a build artifact as part of the release###
      
    # - name: Upload release asset
    #   uses: actions/upload-release-asset@v1
    #   env:
    #      GITHUB_TOKEN: ${{ secrets.github_token }}
    #   with:
    #    upload_url: ${{ steps.create_release.outputs.upload_url }}
    #    asset_path: ./${{ github.sha }}.zip
    #    asset_name: source_code_with_libraries.zip
    #    asset_content_type: application/zip

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Azure CLI script
      uses: azure/cli@v2
      with:
        azcliversion: 2.58.0
        inlineScript: |
          azcopy copy ${{ github.sha }}.zip “https://statfstaste1993.blob.core.windows.net/releases/”   
  
    - name: 'Deploy to Azure Functions'
      uses: Azure/functions-action@v1
      id: deploy-to-function
      with:
          app-name: 'gha1993'
          slot-name: 'production'
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          scm-do-build-during-deployment: true
          enable-oryx-build: true
          publish-profile: ${{ secrets.AzureAppService_PublishProfile_1d8c830b7acc4e78a63f7087ed1cbf11 }}
